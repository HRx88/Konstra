<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Program Modules - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/admin-sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        .module-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .btn-action {
            padding: 4px 8px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .module-table {
                overflow-x: auto;
            }

            /* Stack header on mobile */
            .main-content>.d-flex {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 15px;
            }

            .main-content>.d-flex>div:last-child {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .main-content>.d-flex>div:last-child a,
            .main-content>.d-flex>div:last-child button {
                width: 100%;
                margin-right: 0 !important;
            }
        }
    </style>
</head>

<body>

    <!-- Admin Sidebar -->
    <nav class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="admin-home.html" class="brand-text"><i class="fas fa-print me-2"></i>AdminPanel</a>
        </div>
        <div class="d-flex flex-column">
            <a href="admin-home.html" class="nav-link" id="nav-dashboard"><i class="fas fa-tachometer-alt"></i>
                Dashboard</a>
            <a href="admin-doc.html" class="nav-link" id="nav-document"><i class="fas fa-folder-open"></i> Document</a>
            <a href="chat.html" class="nav-link" id="nav-chat"><i class="fas fa-comments"></i> Chat</a>
            <a href="my-meetings.html" class="nav-link" id="nav-meeting"><i class="fas fa-video"></i> Meeting</a>
            <a href="admin-printadobe.html" class="nav-link active" id="nav-printadobe"><i
                    class="fas fa-graduation-cap"></i> PrintAdobe</a>
            <a href="admin-credentials.html" class="nav-link" id="nav-credentials"><i class="fas fa-certificate"></i>
                Credentials</a>
            <a href="admin-projects.html" class="nav-link" id="nav-project"><i class="fas fa-tasks"></i> Project</a>
            <a href="admin-profile.html" class="nav-link" id="nav-profile"><i class="fas fa-user-circle"></i>
                Profile</a>
        </div>
        <div class="logout-btn-container">
            <button onclick="logout()" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>
                Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <button class="btn btn-dark d-md-none mb-4"
            onclick="document.getElementById('sidebar').classList.toggle('active')">
            <i class="fas fa-bars"></i>
        </button>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Manage Modules</h2>
                <p class="text-muted mb-0" id="programInfo">Loading program...</p>
            </div>
            <div>
                <a href="admin-printadobe.html" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i> Back to Programs
                </a>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus me-1"></i> Add Module
                </button>
            </div>
        </div>

        <!-- Modules Table -->
        <div class="module-table">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;">#</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Content URL</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="moduleTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i> Loading modules...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add/Edit Module Modal -->
    <div class="modal fade" id="moduleModal" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Module</h5>
                    <button type="button" class="btn-close" onclick="safeHideModal(modal)" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="moduleForm">
                        <input type="hidden" id="moduleId">
                        <div class="mb-3">
                            <label for="moduleTitle" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="moduleTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="moduleDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="moduleDescription" rows="3"></textarea>
                        </div>

                        <!-- Content Source Toggle -->
                        <div class="mb-3">
                            <div class="form-label">Content Source <span class="text-danger">*</span></div>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="contentSource" id="sourceURL" value="url"
                                    checked>
                                <label class="btn btn-outline-primary" for="sourceURL">
                                    <i class="fas fa-link me-1"></i> URL
                                </label>
                                <input type="radio" class="btn-check" name="contentSource" id="sourceFile" value="file">
                                <label class="btn btn-outline-primary" for="sourceFile">
                                    <i class="fas fa-upload me-1"></i> Upload File
                                </label>
                            </div>
                        </div>

                        <!-- URL Input -->
                        <div class="mb-3" id="urlInputSection">
                            <label for="moduleContentURL" class="form-label">Content URL</label>
                            <input type="url" class="form-control" id="moduleContentURL"
                                placeholder="https://www.youtube.com/watch?v=...">
                            <small class="text-muted">Paste YouTube link, Vimeo link, or direct file URL</small>
                        </div>

                        <!-- File Upload -->
                        <div class="mb-3" id="fileInputSection" style="display: none;">
                            <label for="moduleFile" class="form-label">Upload File</label>
                            <div class="border rounded p-4 text-center bg-light" id="dropZone" style="cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                <p class="mb-1">Click to select or drag & drop</p>
                                <small class="text-muted">MP4, WebM, PDF (max 2GB)</small>
                                <input type="file" id="moduleFile" class="d-none"
                                    accept=".mp4,.webm,.ogg,.mov,.pdf,.jpg,.jpeg,.png">
                            </div>
                            <div id="uploadProgress" style="display: none;">
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                        id="progressBar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="uploadStatus">Uploading...</small>
                            </div>
                            <div id="uploadedFileInfo" class="mt-2 p-2 bg-success-subtle rounded"
                                style="display: none;">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <span id="uploadedFileName"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="moduleContentType" class="form-label">Content Type <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="moduleContentType" required
                                onchange="toggleContentSections()">
                                <option value="video">Video</option>
                                <option value="pdf">PDF</option>
                                <option value="article">Article</option>
                                <option value="quiz">Quiz</option>
                            </select>
                        </div>

                        <!-- Quiz Editor Section -->
                        <div id="quizEditorSection" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="form-label mb-0">Quiz Questions <span class="text-danger">*</span></div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQuestion()">
                                    <i class="fas fa-plus me-1"></i> Add Question
                                </button>
                            </div>
                            <div id="quizQuestions" class="border rounded p-2 bg-light"
                                style="max-height: 300px; overflow-y: auto;">
                                <p class="text-muted text-center py-3 mb-0" id="noQuestionsMsg">
                                    No questions yet. Click "Add Question" to create one.
                                </p>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mt-2">
                                <div class="d-flex align-items-center">
                                    <label class="me-2 small fw-bold mb-0" for="requiredCorrectInput">Required
                                        Correct:</label>
                                    <div class="input-group input-group-sm" style="width: 130px;">
                                        <input type="number" id="requiredCorrectInput" class="form-control" value="1"
                                            min="1" onchange="updatePassingScore()" onkeyup="updatePassingScore()">
                                        <span class="input-group-text" id="totalQuestionsLabel">/ 0</span>
                                    </div>
                                </div>
                                <small class="text-muted fst-italic ms-3 flex-grow-1 text-end"
                                    id="passingScoreText">Passing: 70% of questions correct</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="moduleOrderIndex" class="form-label">Order <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="moduleOrderIndex" min="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="safeHideModal(modal)">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveModule()">Save Module</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Module</h5>
                    <button type="button" class="btn-close" onclick="safeHideModal(deleteModal)"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this module? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="safeHideModal(deleteModal)">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const programId = params.get('programId');
        let modules = [];
        let modal;
        let deleteModal;
        let moduleToDeleteId = null;
        let uploadedFileUrl = null; // Store uploaded file URL

        document.addEventListener('DOMContentLoaded', () => {
            if (!programId) {
                console.warn('No programId provided. Defaulting to ProgramID 2 for testing.');
                const url = new URL(window.location);
                url.searchParams.set('programId', '2');
                window.history.replaceState({}, '', url);
                window.location.search = '?programId=2';
                return;
            }

            modal = new bootstrap.Modal(document.getElementById('moduleModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            fetchProgramTitle();
            loadModules();
            setupFileUpload();
        });

        async function fetchProgramTitle() {
            try {
                const response = await fetch(`/api/programs/${programId}`);
                if (response.ok) {
                    const program = await response.json();
                    document.getElementById('programInfo').textContent = `Program: ${program.Title}`;
                } else {
                    document.getElementById('programInfo').textContent = 'Program details unavailable';
                }
            } catch (error) {
                console.error('Error fetching program title:', error);
                document.getElementById('programInfo').textContent = 'Error loading program details';
            }
        }

        // ========== File Upload Setup ==========
        function setupFileUpload() {
            const sourceRadios = document.querySelectorAll('input[name="contentSource"]');
            const urlSection = document.getElementById('urlInputSection');
            const fileSection = document.getElementById('fileInputSection');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('moduleFile');

            // Toggle between URL and File upload
            sourceRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'url') {
                        urlSection.style.display = 'block';
                        fileSection.style.display = 'none';
                    } else {
                        urlSection.style.display = 'none';
                        fileSection.style.display = 'block';
                    }
                });
            });

            // Click to select file
            dropZone.addEventListener('click', () => fileInput.click());

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-primary-subtle');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-primary', 'bg-primary-subtle');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-primary-subtle');
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        async function handleFileUpload(file) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const fileInfo = document.getElementById('uploadedFileInfo');
            const fileName = document.getElementById('uploadedFileName');

            // Reset state
            uploadedFileUrl = null;
            fileInfo.style.display = 'none';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            uploadStatus.textContent = `Uploading ${file.name}...`;

            // Auto-detect content type
            const contentTypeSelect = document.getElementById('moduleContentType');
            if (file.type.startsWith('video/')) {
                contentTypeSelect.value = 'video';
            } else if (file.type === 'application/pdf') {
                contentTypeSelect.value = 'pdf';
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        uploadStatus.textContent = `Uploading... ${percent}%`;
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        if (result.success) {
                            uploadedFileUrl = result.url;
                            progressDiv.style.display = 'none';
                            fileInfo.style.display = 'block';
                            fileName.textContent = file.name;
                        } else {
                            throw new Error(result.message);
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                });

                xhr.addEventListener('error', () => {
                    uploadStatus.textContent = 'Upload failed. Please try again.';
                    progressBar.classList.add('bg-danger');
                });

                xhr.open('POST', '/api/modules/upload');
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = 'Upload failed: ' + error.message;
                progressBar.classList.add('bg-danger');
            }
        }

        // ========== Module CRUD ==========
        async function loadModules() {
            try {
                const response = await fetch(`/api/programs/${programId}/modules`);
                modules = await response.json();

                const tbody = document.getElementById('moduleTableBody');

                if (modules.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                No modules yet. Click "Add Module" to create one.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = modules.map(m => `
                    <tr>
                        <td><strong>${m.OrderIndex}</strong></td>
                        <td>${m.Title}</td>
                        <td><span class="badge bg-secondary">${m.ContentType}</span></td>
                        <td><small class="text-muted">${truncate(m.ContentURL, 40)}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action me-1" 
                                    onclick="openEditModal(${m.ModuleID})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" 
                                    onclick="deleteModule(${m.ModuleID})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading modules:', error);
                document.getElementById('moduleTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-danger">
                            Error loading modules. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Module';
            document.getElementById('moduleForm').reset();
            document.getElementById('moduleId').value = '';

            // Reset file upload state
            uploadedFileUrl = null;
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('sourceURL').checked = true;
            document.getElementById('urlInputSection').style.display = 'block';
            document.getElementById('fileInputSection').style.display = 'none';

            // Reset quiz section
            document.getElementById('quizEditorSection').style.display = 'none';
            document.getElementById('quizQuestions').innerHTML = `<p class="text-muted text-center py-3 mb-0" id="noQuestionsMsg">
                No questions yet. Click "Add Question" to create one.
            </p>`;
            questionCounter = 0;
            questionCounter = 0;
            document.getElementById('requiredCorrectInput').value = 1;
            updatePassingScore();

            // Set next order index
            const nextOrder = modules.length > 0 ? Math.max(...modules.map(m => m.OrderIndex)) + 1 : 1;
            document.getElementById('moduleOrderIndex').value = nextOrder;

            modal.show();
        }

        function openEditModal(moduleId) {
            const module = modules.find(m => m.ModuleID === moduleId);
            if (!module) return;

            document.getElementById('modalTitle').textContent = 'Edit Module';
            document.getElementById('moduleId').value = module.ModuleID;
            document.getElementById('moduleTitle').value = module.Title;
            document.getElementById('moduleDescription').value = module.Description || '';
            document.getElementById('moduleContentType').value = module.ContentType;
            document.getElementById('moduleOrderIndex').value = module.OrderIndex;

            // Reset states
            uploadedFileUrl = null;
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';

            // Handle based on content type
            if (module.ContentType === 'quiz') {
                document.getElementById('urlInputSection').style.display = 'none';
                document.getElementById('fileInputSection').style.display = 'none';
                document.getElementById('quizEditorSection').style.display = 'block';
                document.getElementById('moduleContentURL').value = '';
                document.getElementById('moduleContentURL').value = '';
                // Load quiz questions from JSON
                loadQuizData(module.ContentURL);
            } else {
                document.getElementById('sourceURL').checked = true;
                document.getElementById('urlInputSection').style.display = 'block';
                document.getElementById('fileInputSection').style.display = 'none';
                document.getElementById('quizEditorSection').style.display = 'none';
                document.getElementById('moduleContentURL').value = module.ContentURL;
                // Clear quiz questions when not a quiz type
                document.getElementById('quizQuestions').innerHTML = `<p class="text-muted text-center py-3 mb-0" id="noQuestionsMsg">
                    No questions yet. Click "Add Question" to create one.
                </p>`;
                questionCounter = 0;
                questionCounter = 0;
                document.getElementById('requiredCorrectInput').value = 1;
            }
            updatePassingScore(); // Update display after loading/resetting

            modal.show();
        }

        async function saveModule() {
            const form = document.getElementById('moduleForm');
            const contentType = document.getElementById('moduleContentType').value;

            // Get content URL based on content type
            let contentURL = '';
            let passingPercentage = null;

            if (contentType === 'quiz') {
                // Collect quiz questions from DOM
                // Collect quiz questions from DOM
                const quizData = [];
                const questionCards = document.querySelectorAll('#quizQuestions .card');

                questionCards.forEach(card => {
                    // Use input fields instead of text elements
                    const questionInput = card.querySelector('input[data-field="question"]');
                    const questionText = questionInput ? questionInput.value.trim() : '';

                    const options = [];
                    let correctIndex = -1;

                    const optionInputs = card.querySelectorAll('input[data-field="option"]');
                    const radioInputs = card.querySelectorAll('input[type="radio"]');

                    optionInputs.forEach((input, idx) => {
                        options.push(input.value.trim());
                        // Check corresponding radio button
                        if (radioInputs[idx] && radioInputs[idx].checked) {
                            correctIndex = idx;
                        }
                    });

                    if (questionText && options.length > 0 && correctIndex !== -1) {
                        quizData.push({
                            question: questionText,
                            options: options,
                            correctIndex: correctIndex
                        });
                    }
                });

                // For quiz, serialize questions as JSON
                if (quizData.length === 0) {
                    showToast('Please add at least one question to the quiz.', 'warning');
                    return;
                }

                // Calculate percentage from required count
                const requiredCount = parseInt(document.getElementById('requiredCorrectInput').value);
                const totalQuestions = quizData.length;

                if (isNaN(requiredCount) || requiredCount < 1 || requiredCount > totalQuestions) {
                    showToast(`Please enter a valid required count between 1 and ${totalQuestions}.`, 'warning');
                    return;
                }

                // Calculate percentage with 2 decimal precision to ensure accuracy on reload
                passingPercentage = (requiredCount / totalQuestions) * 100;

                // Wrap questions and settings in object
                const quizPayload = {
                    questions: quizData,
                    settings: {
                        passingPercentage: passingPercentage,
                        requiredCorrect: requiredCount
                    }
                };
                contentURL = JSON.stringify(quizPayload);
            } else {
                // Get content URL from either URL input or uploaded file
                const contentSource = document.querySelector('input[name="contentSource"]:checked').value;

                if (contentSource === 'file' && uploadedFileUrl) {
                    contentURL = uploadedFileUrl;
                } else {
                    contentURL = document.getElementById('moduleContentURL').value;
                }

                // Validate content URL for non-quiz types
                if (!contentURL) {
                    showToast('Please provide a content URL or upload a file.', 'warning');
                    return;
                }
            }

            const moduleId = document.getElementById('moduleId').value;
            const data = {
                title: document.getElementById('moduleTitle').value,
                description: document.getElementById('moduleDescription').value,
                contentURL: contentURL,
                contentType: document.getElementById('moduleContentType').value,
                orderIndex: parseInt(document.getElementById('moduleOrderIndex').value)
            };

            if (!data.title) {
                showToast('Please enter a module title.', 'warning');
                return;
            }

            try {
                let response;
                if (moduleId) {
                    response = await fetch(`/api/modules/${moduleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`/api/programs/${programId}/modules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();

                if (result.success) {
                    safeHideModal(modal);
                    showToast('Module saved successfully!', 'success');
                    await loadModules();
                } else {
                    showToast(result.message || 'Failed to save module', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('Error saving module. Please try again.', 'error');
            }
        }

        function deleteModule(moduleId) {
            moduleToDeleteId = moduleId;
            deleteModal.show();
        }

        async function confirmDelete() {
            if (!moduleToDeleteId) return;

            // Disable button to prevent double submit
            const deleteBtn = document.querySelector('#deleteModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

            try {
                const response = await fetch(`/api/modules/${moduleToDeleteId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    safeHideModal(deleteModal);
                    showToast('Module deleted successfully!', 'success');
                    await loadModules();
                } else {
                    showToast(result.message || 'Failed to delete module', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting module. Please try again.', 'error');
            } finally {
                // Reset button
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
                moduleToDeleteId = null;
            }
        }

        function truncate(str, length) {
            return str.length > length ? str.substring(0, length) + '...' : str;
        }

        // Fix for accessibility focus issue: blur button before hiding modal
        function safeHideModal(modalInstance) {
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // ========== Toast Popup Messages ==========
        function showToast(message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.getElementById('toastPopup');
            if (existingToast) existingToast.remove();

            const colors = {
                success: { bg: '#28a745', icon: 'fa-check-circle' },
                error: { bg: '#dc3545', icon: 'fa-exclamation-circle' },
                warning: { bg: '#ffc107', icon: 'fa-exclamation-triangle' },
                info: { bg: '#17a2b8', icon: 'fa-info-circle' }
            };
            const config = colors[type] || colors.info;

            const toast = document.createElement('div');
            toast.id = 'toastPopup';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${config.bg};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <i class="fas ${config.icon}"></i>
                <span>${message}</span>
            `;

            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Update passing score display based on question count
        function updatePassingScore() {
            const questionCount = document.querySelectorAll('#quizQuestions .card').length;
            const passingText = document.getElementById('passingScoreText');
            const requiredInput = document.getElementById('requiredCorrectInput');
            const totalLabel = document.getElementById('totalQuestionsLabel');

            // Update total label and input max
            if (totalLabel) totalLabel.textContent = `/ ${questionCount}`;
            if (requiredInput) {
                requiredInput.max = questionCount;
                if (questionCount > 0 && parseInt(requiredInput.value) > questionCount) {
                    requiredInput.value = questionCount;
                }
                if (questionCount > 0 && parseInt(requiredInput.value) < 1) {
                    requiredInput.value = 1;
                }
            }

            if (passingText) {
                if (questionCount === 0) {
                    passingText.textContent = `Add questions first`;
                    if (requiredInput) requiredInput.value = 0;
                } else {
                    const required = parseInt(requiredInput.value) || 1;
                    const percentage = Math.round((required / questionCount) * 100);
                    passingText.textContent = `Auto-calculated: ${percentage}%`;
                }
            }
        }

        // ========== Quiz Editor Functions ==========
        let quizQuestions = [];
        let questionCounter = 0;

        function toggleContentSections() {
            const contentType = document.getElementById('moduleContentType').value;
            const urlSection = document.getElementById('urlInputSection');
            const fileSection = document.getElementById('fileInputSection');
            const quizSection = document.getElementById('quizEditorSection');

            if (contentType === 'quiz') {
                urlSection.style.display = 'none';
                fileSection.style.display = 'none';
                quizSection.style.display = 'block';
                document.getElementById('sourceURL').checked = true;
            } else {
                quizSection.style.display = 'none';
                // Show URL/File based on current toggle
                const source = document.querySelector('input[name="contentSource"]:checked').value;
                if (source === 'url') {
                    urlSection.style.display = 'block';
                    fileSection.style.display = 'none';
                } else {
                    urlSection.style.display = 'none';
                    fileSection.style.display = 'block';
                }
            }
        }

        function addQuestion() {
            const container = document.getElementById('quizQuestions');
            const noMsg = document.getElementById('noQuestionsMsg');
            if (noMsg) noMsg.style.display = 'none';

            questionCounter++;
            const qId = 'q' + questionCounter;

            const questionDiv = document.createElement('div');
            questionDiv.className = 'card mb-2';
            questionDiv.id = qId;
            questionDiv.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>Question ${container.querySelectorAll('.card').length + 1}</strong>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion('${qId}')" aria-label="Remove Question">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <input type="text" class="form-control mb-2" placeholder="Enter question..." 
                           data-field="question" id="question_${qId}" name="question_${qId}" aria-label="Question Text" required>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <input type="radio" name="correct_${qId}" value="0" checked aria-label="Select Option A as correct">
                                </span>
                                <input type="text" class="form-control" placeholder="Option A" data-field="option" id="opt_${qId}_0" name="opt_${qId}_0" aria-label="Option A" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <input type="radio" name="correct_${qId}" value="1" aria-label="Select Option B as correct">
                                </span>
                                <input type="text" class="form-control" placeholder="Option B" data-field="option" id="opt_${qId}_1" name="opt_${qId}_1" aria-label="Option B" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <input type="radio" name="correct_${qId}" value="2" aria-label="Select Option C as correct">
                                </span>
                                <input type="text" class="form-control" placeholder="Option C" data-field="option" id="opt_${qId}_2" name="opt_${qId}_2" aria-label="Option C" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <input type="radio" name="correct_${qId}" value="3" aria-label="Select Option D as correct">
                                </span>
                                <input type="text" class="form-control" placeholder="Option D" data-field="option" id="opt_${qId}_3" name="opt_${qId}_3" aria-label="Option D" required>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">Select the radio button next to the correct answer</small>
                </div>
            `;

            container.appendChild(questionDiv);
            updatePassingScore();
        }

        function removeQuestion(qId) {
            const element = document.getElementById(qId);
            if (element) {
                element.remove();
                updateQuestionNumbers();
                updatePassingScore();
            }
        }

        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('#quizQuestions .card');
            questions.forEach((q, index) => {
                const label = q.querySelector('strong');
                if (label) label.textContent = `Question ${index + 1}`;
            });

            if (questions.length === 0) {
                const noMsg = document.getElementById('noQuestionsMsg');
                if (noMsg) noMsg.style.display = 'block';
            }
        }

        function getQuizData() {
            const questions = [];
            const questionCards = document.querySelectorAll('#quizQuestions .card');

            questionCards.forEach(card => {
                const qId = card.id;
                const questionText = card.querySelector('[data-field="question"]').value;
                const optionInputs = card.querySelectorAll('[data-field="option"]');
                const options = Array.from(optionInputs).map(input => input.value);
                const correctIndex = parseInt(card.querySelector(`input[name="correct_${qId}"]:checked`).value);

                if (questionText && options.every(o => o)) {
                    questions.push({
                        question: questionText,
                        options: options,
                        correctIndex: correctIndex
                    });
                }
            });

            return questions;
        }

        function loadQuizData(quizJson) {
            try {
                let questions = [];
                let passingPercentage = 70; // Default

                if (quizJson) {
                    const parsed = JSON.parse(quizJson);
                    if (Array.isArray(parsed)) {
                        // Legacy format: just array of questions
                        questions = parsed;
                    } else if (parsed && parsed.questions) {
                        // New format: object with settings
                        questions = parsed.questions;
                        if (parsed.settings && parsed.settings.passingPercentage) {
                            passingPercentage = parsed.settings.passingPercentage;
                        }
                    }
                }

                const container = document.getElementById('quizQuestions');
                container.innerHTML = '';
                questionCounter = 0;

                if (!questions || questions.length === 0) {
                    container.innerHTML = `<p class="text-muted text-center py-3 mb-0" id="noQuestionsMsg">
                        No questions yet. Click "Add Question" to create one.
                    </p>`;
                    document.getElementById('requiredCorrectInput').value = 0;
                    updatePassingScore();
                    return;
                }

                questions.forEach((q, index) => {
                    addQuestion();
                    const card = container.querySelectorAll('.card')[index];
                    card.querySelector('[data-field="question"]').value = q.question;
                    const optionInputs = card.querySelectorAll('[data-field="option"]');
                    q.options.forEach((opt, i) => {
                        if (optionInputs[i]) optionInputs[i].value = opt;
                    });
                    const qId = card.id;
                    card.querySelector(`input[name="correct_${qId}"][value="${q.correctIndex}"]`).checked = true;
                });

                // Calculate required count based on percentage
                const requiredCount = Math.ceil(questions.length * (passingPercentage / 100));
                document.getElementById('requiredCorrectInput').value = requiredCount;
                updatePassingScore();
            } catch (e) {
                console.error('Error loading quiz data:', e);
                showToast('Error loading quiz: ' + e.message, 'error');
            }
        }
    </script>
</body>

</html>