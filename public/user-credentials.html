<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Credentials - User Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="css/sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        /* --- Card Styles --- */
        .credential-card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            height: 100%;
        }

        .credential-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-img-wrapper {
            height: 220px;
            /* Taller area for the badge image */
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #eee;
            padding: 20px;
        }

        .card-img-top {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            /* Ensures the badge isn't cut off */
            transition: transform 0.3s;
        }

        .credential-card:hover .card-img-top {
            transform: scale(1.05);
        }

        .card-body {
            padding: 20px;
        }

        .program-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #d32f2f;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .issue-date {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .btn-credential {
            width: 100%;
            border-radius: 8px;
            font-weight: 600;
        }

        /* --- Modal Styles --- */
        .modal-fullscreen-custom {
            max-width: 90%;
            margin: 1.75rem auto;
        }

        .cert-frame {
            width: 100%;
            height: 80vh;
            border: none;
            background-color: #ffffff;
        }
    </style>
</head>

<body>

    <nav class="dashboard-sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="brand-text"><i class="fas fa-print me-2"></i>MyPortal</a>
        </div>
        <div class="d-flex flex-column">
            <a href="user-dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
            <a href="user-printadobe.html" class="nav-link"><i class="fas fa-graduation-cap"></i> Printadobe</a>
            <a href="user-credentials.html" class="nav-link active"><i class="fas fa-certificate"></i> Credentials</a>
            <a href="profile.html" class="nav-link"><i class="fas fa-user-circle"></i> Profile</a>
        </div>
        <div class="logout-btn">
            <button onclick="logout()" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>
                Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="container-fluid">
            <div class="mb-4">
                <h2 class="fw-bold">My Badges & Certificates</h2>
                <p class="text-muted">Digital credentials earned from your completed programs.</p>
            </div>

            <div id="loader" class="text-center py-5">
                <div class="spinner-border text-danger" role="status"></div>
                <p class="mt-2 text-muted">Loading your credentials...</p>
            </div>

            <div class="row g-4" id="credentialGrid" style="display:none;">
            </div>

            <div id="emptyState" class="text-center py-5" style="display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486747.png" width="100" alt="No Credentials"
                    class="mb-3 opacity-50">
                <h4>No Credentials Yet</h4>
                <p class="text-muted">Complete a program to earn your first badge!</p>
                <a href="programs.html" class="btn btn-primary mt-2">Browse Programs</a>
            </div>
        </div>
    </main>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Credential Viewer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="certFrame" class="cert-frame" src=""></iframe>
                </div>
                <div class="modal-footer justify-content-between">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        If the badge doesn't appear above, click "Open in New Tab".
                    </small>
                    <div>
                        <a id="downloadBtn" href="#" target="_blank" class="btn btn-outline-dark me-2">
                            <i class="fas fa-download me-2"></i>Download PDF
                        </a>
                        <a id="externalLinkBtn" href="#" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt me-2"></i>Open in New Tab
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // FIX: Updated Authentication Logic
            const member = JSON.parse(localStorage.getItem("memberDetails"));
            const userType = member ? 'User' : null;

            if (!userType) {
                window.location.href = 'login.html';
                return;
            }

            // Note: Assuming member object has 'memberID' or 'userID'.
            // Adjust property name based on your exact object structure (e.g. member.memberID)
            const userId = member.userID || member.memberID;
            loadMyCredentials(userId);
        });

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        async function loadMyCredentials(userId) {
            const grid = document.getElementById('credentialGrid');
            const loader = document.getElementById('loader');
            const emptyState = document.getElementById('emptyState');

            try {
                const res = await fetch(`/api/credentials/my-credentials?userID=${userId}`);
                const credentials = await res.json();

                loader.style.display = 'none';

                if (!res.ok || credentials.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                grid.style.display = 'flex';

                grid.innerHTML = credentials.map(c => {
                    // 1. IMAGE LOGIC: 
                    // Try to use the generated Badge Image first (c.ImageURL).
                    // If not available, use the generic Program Image (c.ProgramImage).
                    // Fallback to a placeholder if both are missing.
                    const displayImage = c.ImageURL || c.ProgramImage || 'https://via.placeholder.com/400x200?text=Badge';

                    // 2. MODAL LOGIC:
                    // We want the modal/iframe to load the Public URL (Credsverse link)
                    // or the PDF if you prefer. Here we use PublicURL as the primary view.
                    const viewUrl = c.PublicURL;

                    return `
                    <div class="col-md-6 col-lg-4 col-xl-3">
                        <div class="credential-card shadow-sm h-100">
                            <img src="${displayImage}" class="card-img-top" alt="${c.ProgramTitle}" 
                                 style="height: 200px; object-fit: contain; background: #f8f9fa; padding: 10px;">
                            
                            <div class="card-body d-flex flex-column">
                                <div class="program-type">${c.ProgramType || 'Certification'}</div>
                                <h5 class="card-title fw-bold mb-2">${c.ProgramTitle}</h5>
                                <div class="issue-date">
                                    <i class="far fa-calendar-alt me-1"></i> Issued: ${new Date(c.IssuedAt).toLocaleDateString()}
                                </div>
                                
                                <div class="mt-auto">
                                    <button onclick="openViewer('${viewUrl}', '${c.PublicURL}', '${c.PdfURL || ''}')" class="btn btn-dark btn-credential">
                                        <i class="fas fa-eye me-2"></i>View Credential
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

            } catch (error) {
                console.error("Error:", error);
                loader.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        // Keep your existing openViewer function
        function openViewer(embedUrl, publicUrl, pdfUrl) {
            const iframe = document.getElementById('certFrame');
            const downloadBtn = document.getElementById('downloadBtn');
            const externalBtn = document.getElementById('externalLinkBtn');

            iframe.src = embedUrl;

            if (pdfUrl) {
                downloadBtn.href = pdfUrl;
                downloadBtn.style.display = 'inline-block';
            } else {
                downloadBtn.style.display = 'none';
            }

            externalBtn.href = publicUrl;

            const modal = new bootstrap.Modal(document.getElementById('viewModal'));
            modal.show();

            document.getElementById('viewModal').addEventListener('hidden.bs.modal', () => {
                iframe.src = "";
            });
        }
    </script>
</body>

</html>