<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Content - Learning Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/sidebar.css">

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            height: 100vh;
        }

        .learning-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Module Sidebar */
        .module-sidebar {
            width: 350px;
            margin-left: 250px;
            /* Offset for fixed navigation sidebar */
            background: white;
            border-right: 1px solid #e1e5e9;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.03);
            z-index: 900;
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }

        .sidebar-header h4 {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .progress-overview {
            padding: 20px 25px;
            background: #fafbfc;
            border-bottom: 1px solid #e1e5e9;
        }

        .progress-bar {
            height: 6px;
            border-radius: 10px;
            background-color: #d32f2f;
        }

        .progress {
            background-color: #e9ecef;
            height: 6px;
            border-radius: 10px;
        }

        .module-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .module-item {
            padding: 18px 25px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .module-item:hover {
            background-color: #fff5f5;
        }

        .module-item.active {
            background-color: #fff1f1;
            border-left: 4px solid #d32f2f;
        }

        .module-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: transparent;
        }

        .module-item.completed .module-checkbox {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            font-size: 0.8rem;
        }

        .module-info {
            flex: 1;
        }

        .module-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
            margin-bottom: 2px;
        }

        .module-type {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-color: #f4f6f9;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            background-color: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .completion-btn {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .completion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
        }

        .completion-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .celebration.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state img {
            width: 200px;
            opacity: 0.6;
            margin-bottom: 20px;
        }

        .content-header {
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .content-header h5 {
            font-weight: 700;
            color: #333;
        }

        .module-description {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .module-sidebar {
                width: 300px;
                margin-left: 70px;
                /* Collapsed sidebar width if applicable, or just smaller */
            }

            /* Assuming main sidebar collapses or just overlaps */
        }

        @media (max-width: 768px) {
            .learning-container {
                flex-direction: column;
                height: auto;
                overflow-y: auto;
            }

            .dashboard-sidebar {
                display: none;
                /* Hide main nav on mobile to focus on content */
            }

            .module-sidebar {
                width: 100%;
                margin-left: 0;
                height: auto;
                max-height: 400px;
                /* Limit height of list on mobile */
                border-right: none;
                border-bottom: 1px solid #e1e5e9;
                order: 2;
                /* Move list below content */
            }

            .content-area {
                padding: 20px;
                height: auto;
                order: 1;
                /* Content on top */
            }

            .sidebar-header {
                padding: 15px 20px;
            }

            .video-container {
                margin-bottom: 15px;
            }

            body {
                overflow-y: auto;
                /* Allow body scroll on mobile */
            }
        }
    </style>
</head>

<body>

    <div class="learning-container">
        <!-- Navigation Sidebar -->
        <nav class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="brand-text"><i class="fas fa-print me-2"></i>MyPortal</a>
            </div>
            <div class="d-flex flex-column">
                <a href="user-dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
                <a href="user-printadobe.html" class="nav-link active"><i class="fas fa-graduation-cap"></i>
                    Printadobe</a>
                <a href="user-credentials.html" class="nav-link"><i class="fas fa-certificate"></i> Credentials</a>
                <a href="profile.html" class="nav-link"><i class="fas fa-user-circle"></i> Profile</a>
            </div>
            <div class="logout-btn">
                <button onclick="logout()" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>
                    Logout</button>
            </div>
        </nav>

        <!-- Module Sidebar -->
        <div class="module-sidebar">
            <div class="sidebar-header"
                style="background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white;">
                <h4 id="programTitle" class="text-white mb-2">Loading...</h4>
                <a href="user-printadobe.html" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i> Back to My Programs
                </a>
            </div>

            <div class="progress-overview">
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">Your Progress</small>
                    <small class="fw-bold" id="progressText">0/0 completed</small>
                </div>
                <div class="progress">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
            </div>

            <div class="module-list" id="moduleList">
                <!-- Modules loaded here -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <div class="content-header">
                <div>
                    <h5 class="mb-0" id="currentModuleTitle">Select a module to begin</h5>
                    <small class="text-muted" id="currentModuleType"></small>
                </div>
            </div>

            <div class="content-main" id="contentMain">
                <div class="empty-state">
                    <i class="fas fa-play-circle" style="font-size: 80px; color: #ddd;"></i>
                    <h4 class="mt-3">Choose a module from the sidebar</h4>
                    <p class="text-muted">Start your learning journey by selecting the first module</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div class="celebration" id="celebration">
        <i class="fas fa-trophy" style="font-size: 60px; color: #ffc107;"></i>
        <h3 class="mt-3">Module Completed!</h3>
        <p class="text-muted">Great job! Keep up the momentum.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Parse URL params
        const params = new URLSearchParams(window.location.search);
        const enrollmentId = params.get('enrollmentId');
        const programId = params.get('programId');

        let modules = [];
        let completedModules = [];
        let currentModule = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!enrollmentId || !programId) {
                alert('Invalid access. Missing enrollment or program ID.');
                window.location.href = 'user-printadobe.html';
                return;
            }

            await loadModules();
            await loadProgress();

            // Start automatic refresh via SSE
            setupSSE();
        });

        async function loadModules(silent = false) {
            try {
                const response = await fetch(`/api/programs/${programId}/modules`);
                const newModules = await response.json();

                // Check if modules have changed (compare IDs and Titles to detect edits)
                const modulesChanged = silent && (
                    newModules.length !== modules.length ||
                    JSON.stringify(newModules.map(m => ({ id: m.ModuleID, title: m.Title }))) !==
                    JSON.stringify(modules.map(m => ({ id: m.ModuleID, title: m.Title })))
                );

                // If currently viewing a module that was just edited, update the UI
                if (silent && currentModule) {
                    const updatedActive = newModules.find(m => m.ModuleID === currentModule.ModuleID);
                    if (updatedActive) {
                        const titleChanged = updatedActive.Title !== currentModule.Title;
                        const descChanged = updatedActive.Description !== currentModule.Description;
                        const typeChanged = updatedActive.ContentType !== currentModule.ContentType;
                        const urlChanged = updatedActive.ContentURL !== currentModule.ContentURL;

                        if (titleChanged || typeChanged) {
                            document.getElementById('currentModuleTitle').textContent = updatedActive.Title;
                            document.getElementById('currentModuleType').textContent = (updatedActive.ContentType || 'video').toUpperCase();
                        }

                        if (descChanged) {
                            const descEl = document.getElementById('lessonDescription');
                            if (descEl) descEl.textContent = updatedActive.Description || 'No description available for this module.';
                        }

                        // If URL changed, we must refresh the content view (re-render player)
                        if (urlChanged) {
                            selectModule(updatedActive, { currentTarget: document.querySelector(`.module-item[data-module-id="${updatedActive.ModuleID}"]`) });
                        }

                        currentModule = updatedActive;
                    }
                }

                modules = newModules;

                // Try to get program title from enrollment or set a default
                if (!silent) {
                    try {
                        const enrollRes = await fetch(`/api/enrollments/my-enrollments?userID=${JSON.parse(localStorage.getItem('memberDetails'))?.memberID}`);
                        const enrollments = await enrollRes.json();
                        const currentEnroll = enrollments.find(e => e.EnrollmentID == enrollmentId);
                        if (currentEnroll) {
                            document.getElementById('programTitle').textContent = currentEnroll.ProgramTitle;
                        } else {
                            document.getElementById('programTitle').textContent = 'Course Content';
                        }
                    } catch (e) {
                        document.getElementById('programTitle').textContent = 'Course Content';
                    }
                }

                if (modules.length === 0) {
                    document.getElementById('moduleList').innerHTML = `
                        <p class="text-center text-muted p-4">No modules available yet.</p>
                    `;
                    return;
                }

                updateModuleList();
                updateProgress();

                // Show notification if new modules were added (only during silent refresh)
                if (silent && modulesChanged) {
                    showModuleUpdateNotification();
                }
            } catch (error) {
                console.error('Error loading modules:', error);
            }
        }

        // Show a subtle notification when modules are updated
        function showModuleUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <i class="fas fa-sync-alt me-2"></i>
                <span>Module list updated</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Set up real-time updates via SSE
        let eventSource = null;
        function setupSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(`/api/programs/${programId}/modules/events`);

            eventSource.onopen = function () {
                console.log('Connected to module update stream');
            };

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'moduleUpdate') {
                    // Module list changed, refresh it silently
                    loadModules(true);
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSE Error:', error);
                eventSource.close();
                // Try to reconnect after 5 seconds
                setTimeout(setupSSE, 5000);
            };
        }

        async function loadProgress() {
            try {
                const response = await fetch(`/api/enrollments/${enrollmentId}/progress`);
                completedModules = await response.json();

                updateProgress();
                updateModuleList();
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        function updateModuleList() {
            const moduleList = document.getElementById('moduleList');

            // Remember currently active module ID
            const activeModuleId = currentModule ? currentModule.ModuleID : null;

            moduleList.innerHTML = '';

            modules.forEach(module => {
                const isCompleted = completedModules.some(c => c.ModuleID === module.ModuleID);
                const isActive = activeModuleId === module.ModuleID;

                const item = document.createElement('div');
                item.className = `module-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}`;
                item.dataset.moduleId = module.ModuleID;
                item.onclick = (e) => selectModule(module, e);

                item.innerHTML = `
                    <div class="module-checkbox">
                        ${isCompleted ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="module-info">
                        <div class="module-title">${module.OrderIndex}. ${module.Title}</div>
                        <div class="module-type">${module.ContentType || 'video'}</div>
                    </div>
                `;

                moduleList.appendChild(item);
            });
        }

        function selectModule(module, event) {
            currentModule = module;

            // Update active state
            document.querySelectorAll('.module-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update header
            document.getElementById('currentModuleTitle').textContent = module.Title;
            document.getElementById('currentModuleType').textContent = (module.ContentType || 'video').toUpperCase();

            // Render content based on type
            const contentMain = document.getElementById('contentMain');
            const isCompleted = completedModules.some(c => c.ModuleID === module.ModuleID);

            let contentHTML = '';
            let autoMarkEnabled = !isCompleted; // Only auto-mark if not already completed

            // Handle Video
            if (module.ContentType === 'video' || !module.ContentType) {
                const url = module.ContentURL || '';

                // Check if it's a direct video file (MP4, WebM, etc.)
                if (url.match(/\.(mp4|webm|ogg)($|\?)/i)) {
                    // HTML5 Video Player with auto-complete on ended
                    contentHTML = `
                        <div class="video-container shadow-sm mb-4" style="padding-bottom: 0; height: auto;">
                            <video id="videoPlayer" controls style="width: 100%; border-radius: 12px;">
                                <source src="${url}" type="video/${url.split('.').pop().split('?')[0]}">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else {
                    // YouTube/External embed
                    const embedUrl = getEmbedUrl(url);
                    const isYouTube = embedUrl.includes('youtube.com/embed/');

                    if (isYouTube && autoMarkEnabled) {
                        // YouTube with API for auto-complete
                        const videoId = embedUrl.split('embed/')[1].split('?')[0];
                        contentHTML = `
                            <div class="video-container shadow-sm mb-4">
                                <div id="ytPlayer" data-video-id="${videoId}"></div>
                            </div>
                            <p class="text-muted small text-center"><i class="fas fa-info-circle me-1"></i> This module will be marked complete when the video ends.</p>
                        `;
                    } else {
                        // Generic iframe (manual complete required)
                        contentHTML = `
                            <div class="video-container shadow-sm mb-4">
                                <iframe src="${embedUrl}" 
                                        title="${module.Title}"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen></iframe>
                            </div>
                        `;
                    }
                }
            }
            // Handle PDF - timed completion button (scroll detection doesn't work on iframes)
            else if (module.ContentType === 'pdf') {
                contentHTML = `
                    <div class="card mb-4 border-0 shadow-sm" style="height: 600px; position: relative;">
                        <iframe id="pdfViewer" src="${module.ContentURL}" width="100%" height="100%" style="border:none;">
                            This browser does not support PDFs. Please download the PDF to view it: <a href="${module.ContentURL}">Download PDF</a>
                        </iframe>
                    </div>
                    <div id="pdfCompleteSection" class="text-center">
                        <p class="text-muted small mb-2">
                            <i class="fas fa-info-circle me-1"></i> 
                            Please read through the PDF, then click the button below to mark as complete.
                        </p>
                        <button id="pdfCompleteBtn" class="btn btn-success" onclick="completeModule()" disabled>
                            <i class="fas fa-spinner fa-spin me-2" id="pdfBtnSpinner"></i>
                            <span id="pdfBtnText">Available in <span id="pdfCountdown">10</span>s...</span>
                        </button>
                    </div>
                `;
            }
            // Handle Article/Link - scroll detection
            else if (module.ContentType === 'article') {
                contentHTML = `
                    <div class="card mb-4 border-0 shadow-sm overflow-hidden" id="articleContainer">
                        <div class="ratio" style="--bs-aspect-ratio: 100%; max-height: 800px; height: 600px;">
                            <iframe src="${module.ContentURL}" class="w-100 h-100 border-0" allowfullscreen title="Article Content" id="articleIframe"></iframe>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="${module.ContentURL}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i> Open Original Link
                        </a>
                        <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i> Scroll content to view more</p>
                    </div>
                `;

                // Add iframe error handling with timeout
                setTimeout(() => {
                    const iframe = document.getElementById('articleIframe');
                    const container = document.getElementById('articleContainer');

                    if (iframe && container) {
                        // Set up error handler for iframe load failures
                        iframe.addEventListener('error', () => {
                            showArticleFallback(container, module.ContentURL);
                        });

                        // Also check if iframe is blocked after a timeout
                        setTimeout(() => {
                            try {
                                // Try to access iframe content - will throw if blocked by CORS
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (!iframeDoc || iframeDoc.body.innerHTML === '') {
                                    // Iframe appears empty, might be blocked
                                    showArticleFallback(container, module.ContentURL);
                                }
                            } catch (e) {
                                // CORS or other security restriction - use fallback
                                showArticleFallback(container, module.ContentURL);
                            }
                        }, 3000); // Wait 3 seconds for iframe to load
                    }
                }, 100);

                function showArticleFallback(container, url) {
                    container.innerHTML = `
                        <div class="card-body text-center py-5">
                            <i class="fas fa-external-link-alt fa-4x text-primary mb-4"></i>
                            <h4>Article Link</h4>
                            <p class="text-muted mb-4">This content is hosted externally and cannot be displayed directly.</p>
                            <a href="${url}" target="_blank" class="btn btn-primary btn-lg">
                                <i class="fas fa-arrow-right me-2"></i> Open Article
                            </a>
                            <div class="mt-4 text-start bg-light p-3 rounded small">
                                <strong>URL:</strong>
                                <a href="${url}" target="_blank" class="text-break">${url}</a>
                            </div>
                        </div>
                    `;
                }
            }
            // Handle Quiz
            else if (module.ContentType === 'quiz') {
                try {
                    const parsed = JSON.parse(module.ContentURL);
                    let quizData = [];
                    let passingPercentage = 70;
                    let manualRequired = null;

                    if (Array.isArray(parsed)) {
                        quizData = parsed;
                    } else if (parsed && parsed.questions) {
                        quizData = parsed.questions;
                        if (parsed.settings) {
                            if (parsed.settings.passingPercentage) passingPercentage = parsed.settings.passingPercentage;
                            if (parsed.settings.requiredCorrect) manualRequired = parsed.settings.requiredCorrect;
                        }
                    }

                    const totalQuestions = quizData.length;
                    const requiredCorrect = manualRequired || Math.ceil(totalQuestions * (passingPercentage / 100));

                    let quizHTML = `
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-question-circle me-2 text-primary"></i>Quiz</h5>
                                <span class="badge bg-primary">${totalQuestions} Questions</span>
                            </div>
                            <div class="alert alert-info py-2 mb-3">
                                <i class="fas fa-bullseye me-2"></i>
                                <strong>Passing Requirement:</strong> Get at least ${requiredCorrect} out of ${totalQuestions} questions correct
                            </div>
                            <form id="quizForm" data-required="${requiredCorrect}">
                                `;

                    quizData.forEach((q, index) => {
                        quizHTML += `
                            <div class="mb-4 p-3 bg-light rounded">
                                <p class="fw-bold mb-3">${index + 1}. ${q.question}</p>
                                <div class="ms-3">
                        `;
                        q.options.forEach((opt, optIndex) => {
                            quizHTML += `
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="q${index}" 
                                               id="q${index}_opt${optIndex}" value="${optIndex}" required>
                                        <label class="form-check-label" for="q${index}_opt${optIndex}">${opt}</label>
                                    </div>
                            `;
                        });
                        quizHTML += `
                        </div>
                            </div >
                    `;
                    });

                    quizHTML += `
                                </form >
                                <div class="text-center mt-4">
                                    <button class="btn btn-primary btn-lg px-5" onclick="submitQuiz()">
                                        <i class="fas fa-paper-plane me-2"></i>Submit Quiz
                                    </button>
                                </div>
                                <p class="text-muted small text-center mt-2">
                                    <i class="fas fa-info-circle me-1"></i>You need at least ${requiredCorrect}/${totalQuestions} correct to pass
                                </p>
                            </div>
                        </div>
                    `;
                    contentHTML = quizHTML;
                } catch (e) {
                    contentHTML = `<div class="alert alert-danger">Error loading quiz data</div>`;
                }
            }
            // Handle External Link (manual)
            else {
                contentHTML = `
                    <div class="p-5 text-center bg-light rounded-3 mb-4">
                        <i class="fas fa-external-link-alt fa-3x text-primary mb-3"></i>
                        <h4>External Resource</h4>
                        <p class="text-muted">This module links to an external resource.</p>
                        <a href="${module.ContentURL}" target="_blank" class="btn btn-primary mt-2">
                            Open Resource <i class="fas fa-arrow-right ms-2"></i>
                        </a>
                    </div>
                `;
            }

            contentMain.innerHTML = `
                ${contentHTML}
                <div class="module-description">
                    <h5>About this lesson</h5>
                    <p class="text-muted mt-2" id="lessonDescription">${module.Description || 'No description available for this module.'}</p>
                </div>
                `;

            // Scroll to top
            contentMain.scrollTop = 0;

            // Setup auto-complete listeners (only if not already completed)
            if (autoMarkEnabled) {
                setupAutoComplete(module.ContentType || 'video');
            }
        }

        // Watch time tracking variables
        let watchedSeconds = 0;
        let videoDuration = 0;
        let watchInterval = null;
        let pdfTimer = null; // Global PDF timer
        const REQUIRED_WATCH_PERCENT = 0.90; // Must watch 90% of video

        // Auto-complete setup based on content type
        function setupAutoComplete(contentType) {
            // Reset watch time
            watchedSeconds = 0;
            videoDuration = 0;
            if (watchInterval) clearInterval(watchInterval);
            if (pdfTimer) clearInterval(pdfTimer); // Clear existing PDF timer

            // HTML5 Video: Track actual watch time
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoDuration = videoPlayer.duration;
                });

                // Track time while playing (not when paused/seeking)
                videoPlayer.addEventListener('playing', () => {
                    watchInterval = setInterval(() => {
                        if (!videoPlayer.paused && !videoPlayer.seeking) {
                            watchedSeconds++;
                            updateWatchProgress();
                        }
                    }, 1000);
                });

                videoPlayer.addEventListener('pause', () => {
                    if (watchInterval) clearInterval(watchInterval);
                });

                videoPlayer.addEventListener('ended', () => {
                    if (watchInterval) clearInterval(watchInterval);
                    checkWatchCompletion();
                });
                return;
            }

            // YouTube Player: Track watch time with API
            const ytPlayerDiv = document.getElementById('ytPlayer');
            if (ytPlayerDiv) {
                const videoId = ytPlayerDiv.dataset.videoId;
                if (videoId && typeof YT !== 'undefined' && YT.Player) {
                    initYouTubePlayer(videoId);
                } else {
                    loadYouTubeAPI(videoId);
                }
                return;
            }

            // Scroll detection for articles/PDFs (unchanged)
            const articleContent = document.getElementById('articleContent');
            if (articleContent) {
                let hasCompleted = false;
                articleContent.addEventListener('scroll', () => {
                    if (hasCompleted) return;
                    const scrollHeight = articleContent.scrollHeight;
                    const scrollTop = articleContent.scrollTop;
                    const clientHeight = articleContent.clientHeight;

                    if (scrollTop + clientHeight >= scrollHeight - 20) {
                        hasCompleted = true;
                        console.log('Article scrolled to bottom - auto-marking complete');
                        completeModule();
                    }
                });
            }

            // PDF: Enable button after countdown (scroll can't be detected on iframes)
            const pdfCompleteBtn = document.getElementById('pdfCompleteBtn');
            if (pdfCompleteBtn) {
                let countdown = 10;
                const countdownEl = document.getElementById('pdfCountdown');
                const spinnerEl = document.getElementById('pdfBtnSpinner');
                const textEl = document.getElementById('pdfBtnText');

                pdfTimer = setInterval(() => {
                    countdown--;
                    if (countdownEl) countdownEl.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(pdfTimer);
                        pdfCompleteBtn.disabled = false;
                        if (spinnerEl) spinnerEl.className = 'fas fa-check-circle me-2';
                        if (textEl) textEl.innerHTML = 'I have read this PDF';
                    }
                }, 1000);
            }
        }

        // Initialize YouTube player with watch tracking
        function initYouTubePlayer(videoId) {
            let ytPlayer = new YT.Player('ytPlayer', {
                videoId: videoId,
                playerVars: {
                    'origin': window.location.origin,
                    'rel': 0,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': (event) => {
                        videoDuration = event.target.getDuration();
                    },
                    'onStateChange': (event) => {
                        // YT.PlayerState: PLAYING=1, PAUSED=2, ENDED=0
                        if (event.data === 1) { // Playing
                            watchInterval = setInterval(() => {
                                watchedSeconds++;
                                updateWatchProgress();
                            }, 1000);
                        } else if (event.data === 2 || event.data === 0) { // Paused or Ended
                            if (watchInterval) clearInterval(watchInterval);
                            if (event.data === 0) {
                                checkWatchCompletion();
                            }
                        }
                    }
                }
            });
        }

        // Load YouTube IFrame API dynamically
        function loadYouTubeAPI(videoId) {
            if (window.ytApiLoading) return;
            window.ytApiLoading = true;

            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            window.onYouTubeIframeAPIReady = function () {
                const ytPlayerDiv = document.getElementById('ytPlayer');
                if (ytPlayerDiv) {
                    initYouTubePlayer(ytPlayerDiv.dataset.videoId);
                }
            };
        }

        // Update watch progress indicator
        function updateWatchProgress() {
            // Progress is tracked silently - no console log needed
        }

        // Check if user watched enough to mark complete
        function checkWatchCompletion() {
            if (videoDuration <= 0) {
                completeModule();
                return;
            }

            const watchPercent = watchedSeconds / videoDuration;

            if (watchPercent >= REQUIRED_WATCH_PERCENT) {
                completeModule();
            } else {
                const percentNeeded = Math.round(REQUIRED_WATCH_PERCENT * 100);
                const percentWatched = Math.round(watchPercent * 100);
                showErrorPopup(`You've only watched ${percentWatched}% of this video. Please watch at least ${percentNeeded}% to complete this module.`);
            }
        }

        // Show styled error popup
        function showErrorPopup(message) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'errorOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';

            // Create popup
            overlay.innerHTML = `
                <div style="background:white;padding:40px;border-radius:15px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <i class="fas fa-exclamation-circle" style="font-size:50px;color:#d32f2f;margin-bottom:20px;"></i>
                    <h4 style="margin-bottom:15px;color:#333;">Watch More to Complete</h4>
                    <p style="color:#666;margin-bottom:25px;">${message}</p>
                    <button onclick="document.getElementById('errorOverlay').remove()" 
                            style="background:#d32f2f;color:white;border:none;padding:12px 30px;border-radius:25px;font-weight:600;cursor:pointer;">
                        Got it
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // Helper to convert YouTube URLs to Embed URLs
        function getEmbedUrl(url) {
            if (!url) return '';

            // Handle YouTube
            let videoId = '';

            // https://www.youtube.com/watch?v=VIDEO_ID
            if (url.includes('youtube.com/watch')) {
                const urlParams = new URLSearchParams(new URL(url).search);
                videoId = urlParams.get('v');
            }
            // https://youtu.be/VIDEO_ID
            else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            }
            // Already embed URL
            else if (url.includes('youtube.com/embed/')) {
                return url;
            }

            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}?rel=0&enablejsapi=1&origin=${window.location.origin}`;
            }

            // Handle Vimeo (simple check)
            if (url.includes('vimeo.com')) {
                // Assuming standard vimeo.com/ID format -> player.vimeo.com/video/ID
                const vimeoId = url.split('vimeo.com/')[1];
                if (vimeoId && /^\d+$/.test(vimeoId)) {
                    return `https://player.vimeo.com/video/${vimeoId}`;
                }
            }

            return url;
        }

        async function completeModule() {
            if (!currentModule) return;

            const completeBtn = document.getElementById('completeBtn');
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Completing...';
            }

            try {
                const response = await fetch(`/api/enrollments/${enrollmentId}/modules/${currentModule.ModuleID}/complete`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    // Show celebration
                    const celebration = document.getElementById('celebration');
                    celebration.classList.add('show');
                    setTimeout(() => {
                        celebration.classList.remove('show');
                    }, 2000);

                    // Reload progress
                    await loadProgress();

                    // Hide button
                    if (completeBtn) completeBtn.style.display = 'none';
                } else {
                    // Only show error if it's not "Module already completed" (optional, but requested to remove "localhost says" message)
                    // The user said "remove all the localhost:8000 say message" which implies replacing alert with toast.
                    showToast(result.message || 'Failed to mark module as complete', 'info');

                    if (completeBtn) {
                        completeBtn.disabled = false;
                        completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Mark as Complete';
                    }
                }
            } catch (error) {
                console.error('Completion error:', error);
                showToast('Error completing module', 'error');
                if (completeBtn) {
                    completeBtn.disabled = false;
                    completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Mark as Complete';
                }
            }
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const existingToast = document.getElementById('toastPopup');
            if (existingToast) existingToast.remove();

            const colors = {
                success: { bg: '#28a745', icon: 'fa-check-circle' },
                error: { bg: '#dc3545', icon: 'fa-exclamation-circle' },
                warning: { bg: '#ffc107', icon: 'fa-exclamation-triangle' },
                info: { bg: '#17a2b8', icon: 'fa-info-circle' }
            };
            const config = colors[type] || colors.info;

            const toast = document.createElement('div');
            toast.id = 'toastPopup';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${config.bg};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <i class="fas ${config.icon}"></i>
                <span>${message}</span>
            `;

            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateProgress() {
            const total = modules.length;
            const completed = completedModules.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('progressText').textContent = `${completed}/${total} completed`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // ========== Quiz Submission ==========
        function submitQuiz() {
            if (!currentModule) return;

            try {
                const parsed = JSON.parse(currentModule.ContentURL);
                let quizData = [];
                let passingPercentage = 70;

                if (Array.isArray(parsed)) {
                    quizData = parsed;
                } else if (parsed && parsed.questions) {
                    quizData = parsed.questions;
                    if (parsed.settings && parsed.settings.passingPercentage) {
                        passingPercentage = parsed.settings.passingPercentage;
                    }
                }

                const form = document.getElementById('quizForm');

                // Check all questions answered
                let allAnswered = true;
                quizData.forEach((_, index) => {
                    const selected = form.querySelector(`input[name="q${index}"]:checked`);
                    if (!selected) allAnswered = false;
                });

                if (!allAnswered) {
                    showQuizResult(false, 'Please answer all questions before submitting.');
                    return;
                }

                // Calculate score and highlight answers
                let correct = 0;
                quizData.forEach((q, index) => {
                    const selected = form.querySelector(`input[name="q${index}"]:checked`);
                    const questionDiv = form.querySelectorAll('.mb-4.p-3.bg-light.rounded')[index];
                    const allOptions = form.querySelectorAll(`input[name="q${index}"]`);

                    // Mark each option
                    allOptions.forEach((opt, optIdx) => {
                        const label = opt.closest('.form-check');
                        if (optIdx === q.correctIndex) {
                            // Correct answer - always show green
                            label.classList.add('text-success');
                            label.innerHTML = label.innerHTML + ' <i class="fas fa-check-circle text-success"></i>';
                        } else if (selected && parseInt(selected.value) === optIdx && optIdx !== q.correctIndex) {
                            // Wrong answer selected - show red
                            label.classList.add('text-danger');
                            label.innerHTML = label.innerHTML + ' <i class="fas fa-times-circle text-danger"></i>';
                        }
                        opt.disabled = true; // Disable all options after submit
                    });

                    if (selected && parseInt(selected.value) === q.correctIndex) {
                        correct++;
                        if (questionDiv) questionDiv.style.borderLeft = '4px solid #28a745';
                    } else {
                        if (questionDiv) questionDiv.style.borderLeft = '4px solid #dc3545';
                    }
                });

                const score = Math.round((correct / quizData.length) * 100);
                const requiredCorrect = parseInt(form.dataset.required) || Math.ceil(quizData.length * 0.7);
                const passed = correct >= requiredCorrect;

                // Update submit button to show results
                const submitBtn = document.querySelector('#quizForm + .text-center button');
                if (submitBtn) {
                    if (passed) {
                        submitBtn.outerHTML = `
                            <div class="alert alert-success text-center">
                                <h5><i class="fas fa-trophy me-2"></i>Your Score: ${score}%</h5>
                                <p class="mb-0">${correct}/${quizData.length} correct answers</p>
                            </div>
                        `;
                    } else {
                        submitBtn.outerHTML = `
                            <div class="alert alert-warning text-center">
                                <h5><i class="fas fa-exclamation-circle me-2"></i>Your Score: ${score}%</h5>
                                <p>${correct}/${quizData.length} correct answers</p>
                                <button class="btn btn-primary mt-2" onclick="retakeQuiz()">
                                    <i class="fas fa-redo me-2"></i>Retake Quiz
                                </button>
                            </div>
                        `;
                    }
                }

                if (passed) {
                    showQuizResult(true, `Congratulations! You scored ${score}% (${correct}/${quizData.length} correct)`);
                    completeModule();
                } else {
                    showQuizResult(false, `You scored ${score}% (${correct}/${quizData.length} correct). You need at least ${requiredCorrect} correct to pass.`);
                }
            } catch (e) {
                console.error('Quiz submission error:', e);
                showQuizResult(false, 'Error processing quiz. Please try again.');
            }
        }

        function showQuizResult(passed, message) {
            const overlay = document.createElement('div');
            overlay.id = 'quizResultOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';

            overlay.innerHTML = `
                <div style="background:white;padding:40px;border-radius:15px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <i class="fas ${passed ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'}" 
                       style="font-size:60px;margin-bottom:20px;"></i>
                    <h4 style="margin-bottom:15px;color:#333;">${passed ? 'Quiz Passed!' : 'Quiz Not Passed'}</h4>
                    <p style="color:#666;margin-bottom:25px;">${message}</p>
                    <button onclick="document.getElementById('quizResultOverlay').remove()" 
                            style="background:${passed ? '#28a745' : '#d32f2f'};color:white;border:none;padding:12px 30px;border-radius:25px;font-weight:600;cursor:pointer;">
                        ${passed ? 'Continue' : 'Try Again'}
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // Retake quiz - reload the current module
        function retakeQuiz() {
            if (currentModule) {
                // Re-render the module content to reset the quiz
                const moduleItem = document.querySelector(`.module-item[data-module-id="${currentModule.ModuleID}"]`);
                if (moduleItem) {
                    selectModule(currentModule, { currentTarget: moduleItem });
                } else {
                    // Fallback - just re-select the module
                    selectModule(currentModule, { currentTarget: document.querySelector('.module-item.active') });
                }
            }
        }
    </script>
</body>

</html>